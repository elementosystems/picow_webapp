---

name: "PR Build & Test Docker Image"

on:
  pull_request:
    branches:
      - main

jobs:
  lint:
    name: "Lint"
    runs-on: ["self-hosted"]
    steps:
      - name: "Check out the codebase"
        uses: actions/checkout@v6

      - name: "Set up Python 3"
        uses: actions/setup-python@v6
        with:
          python-version: "3.x"

      - name: "Install test dependencies"
        run: |
          pip3 install yamllint

      - name: "Lint all the YAMLs"
        run: yamllint .

  build:
    runs-on: ["self-hosted"]
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v6

      - name: "Set up Node.js"
        uses: actions/setup-node@v6
        with:
          node-version: "18"
          cache: 'npm'

      - name: "Install Dependencies"
        run: npm ci

      - name: "Build Production Assets"
        run: npm run build

      - name: "Verify version consistency"
        shell: bash
        run: |
          # Extract version from version.json and store it in VERSION
          VERSION=$(jq -r '.version' version.json)
          echo "version.json version: $VERSION"

          # Extract version from index.html. Prefer meta tag, fall back to footer.
          html_version=$(sed -n 's/.*<meta name="app-version" content="\([^"]*\)".*/\1/p' index.html)
          if [ -z "$html_version" ]; then
            html_version=$(tr '\n' ' ' < index.html | sed -E -n 's/.*<div style="flex: 1; text-align: right; font-weight: bold;">[[:space:]]*v([0-9.]+).*<\/div>.*/\1/p')
          fi
          echo "index.html version: $html_version"

          # Compare versions (fail if mismatched)
          if [ "$VERSION" != "$html_version" ]; then
            echo "Version mismatch: version.json ($VERSION) and index.html ($html_version)"
            exit 1
          fi

      - name: "Set up QEMU"
        uses: docker/setup-qemu-action@v3

      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "Build Docker image for x86"
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --load \
            -t harbor.elementosystems.com/pico_webapp/picow_webapp:v${{ env.VERSION }}-amd64 \
            .

      - name: "Build Docker image for arm v7"
        run: |
          docker buildx build \
            --platform linux/arm/v7 \
            --load \
            -t harbor.elementosystems.com/pico_webapp/picow_webapp:v${{ env.VERSION }}-armv7 \
            .

      - name: "Build Docker image for arm64"
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -t harbor.elementosystems.com/pico_webapp/picow_webapp:v${{ env.VERSION }}-amd64 \
            --load \
            .

      - name: "Verify Docker Image"
        run: docker images | grep picow_webapp
