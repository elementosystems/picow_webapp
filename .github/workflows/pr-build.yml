---

name: "PR Build & Test Docker Image"

on:
  pull_request:
    branches:
      - main

jobs:
  lint:
    name: "Lint"
    runs-on: ["self-hosted"]
    steps:
      - name: "Check out the codebase"
        uses: actions/checkout@v6

      - name: "Set up Python 3"
        uses: actions/setup-python@v6
        with:
          python-version: "3.x"

      - name: "Install test dependencies"
        run: |
          pip3 install yamllint

      - name: "Lint all the YAMLs"
        run: yamllint .

  build:
    runs-on: ["self-hosted"]
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v6

      - name: "Set up Node.js"
        uses: actions/setup-node@v6
        with:
          node-version: "18"
          cache: 'npm'

      - name: "Install Dependencies"
        run: npm ci

      - name: "Check Version Consistency"
        run: npm run check-versions

      - name: "Build Production Assets"
        run: npm run build

      - name: "Extract Version"
        shell: bash
        run: |
          VERSION=$(jq -r '.version' version.json)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: "Set up QEMU"
        uses: docker/setup-qemu-action@v3

      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "Build Docker image for x86"
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --load \
            -t harbor.elementosystems.com/pico_webapp/picow_webapp:v${{ env.VERSION }}-amd64 \
            .

      - name: "Build Docker image for arm v7"
        run: |
          docker buildx build \
            --platform linux/arm/v7 \
            --load \
            -t harbor.elementosystems.com/pico_webapp/picow_webapp:v${{ env.VERSION }}-armv7 \
            .

      - name: "Build Docker image for arm64"
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -t harbor.elementosystems.com/pico_webapp/picow_webapp:v${{ env.VERSION }}-amd64 \
            --load \
            .

      - name: "Verify Docker Image"
        run: docker images | grep picow_webapp
